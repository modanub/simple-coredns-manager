# simple-coredns-gslb-manager

A lightweight web UI for managing [CoreDNS](https://coredns.io/) configuration with **GSLB** (Global Server Load Balancing) support via [CoreDNS-GSLB](https://github.com/dmachard/coredns-gslb). Edit your Corefile, BIND zone files, and GSLB configurations with diff preview, then reload CoreDNS with one click.

> **Note:** This project was fully generated by [Claude Opus 4.6](https://www.anthropic.com/claude) (Anthropic's AI model) via [Claude Code](https://claude.com/claude-code) as an experiment in AI-driven software development. No human-written code.
>
> Originally built for the infrastructure part of [MWIT-LINK](https://mwit.link/) (Mahidol Wittayanusorn School) to manage internal DNS records.

## Features

- **Corefile editor** — Edit your CoreDNS Corefile in a web-based editor with syntax-aware textarea
- **Zone file management** — Create, edit, and delete BIND zone files (`db.example.com` format) with support for A, AAAA, CNAME, MX, TXT, and NS records
- **GSLB management** — Full web UI for managing CoreDNS-GSLB configurations:
  - Create and manage GSLB zones with YAML-based configs
  - Add/remove GSLB records with configurable load balancing modes (failover, round-robin, random, weighted, GeoIP)
  - Manage backends per record with health check profiles, priorities, weights, and locations
  - Reusable health check profile management (HTTP, HTTPS, TCP, ICMP)
  - Raw YAML editor with diff preview for advanced editing
- **SOA auto-management** — SOA serial auto-increments (YYYYMMDDNN format) on every save
- **Diff preview** — See unified diffs of your changes before saving (powered by HTMX)
- **One-click reload** — Send SIGUSR1 to CoreDNS container to pick up config changes
- **Master password auth** — Simple single-password login with bcrypt + JWT cookie sessions
- **Docker-native** — Runs alongside CoreDNS-GSLB sharing config volumes, communicates via Docker socket
- **Graceful degradation** — Works without Docker socket (reload features disabled)
- **OctoDNS compatible** — Standard BIND zone files work with `octodns-bind` out of the box
- **Prometheus metrics** — CoreDNS-GSLB exposes metrics on port 9153

## Quick Start

```bash
git clone https://github.com/modanub/simple-coredns-manager.git
cd simple-coredns-manager
docker compose up --build
```

Open [http://localhost:8080](http://localhost:8080) and log in with password `changeme`.

The setup uses `dmachard/coredns_gslb:latest` which includes both standard CoreDNS and GSLB plugin support.

## Configuration

All configuration is via environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `COREFILE_PATH` | *(required)* | Path to the CoreDNS Corefile |
| `ZONE_DIR` | Corefile directory | Directory containing zone files (`db.*`) |
| `GSLB_DIR` | Same as `ZONE_DIR` | Directory containing GSLB YAML configs (`db.*.yml`) |
| `MASTER_PASSWORD` | *(required)* | Plaintext or bcrypt hash (auto-detected by `$2a$`/`$2b$` prefix) |
| `JWT_SECRET` | *(required)* | Secret key for signing JWT session tokens |
| `COREDNS_CONTAINER_NAME` | `coredns` | Docker container name for CoreDNS |
| `PORT` | `8080` | HTTP listen port |

`HOSTS_DIR` is accepted as a fallback for `ZONE_DIR` for backward compatibility.

### Using a pre-hashed password

```bash
# Generate a bcrypt hash
htpasswd -nbBC 12 "" 'your-password' | cut -d: -f2

# Use it directly
MASTER_PASSWORD='$2b$12$...'
```

## GSLB Setup

The GSLB plugin uses two files per zone:

1. **BIND zone file** (`db.gslb.example.com`) — Standard zone with SOA and NS records
2. **YAML config** (`db.gslb.example.com.yml`) — GSLB records, backends, and health checks

### Example Corefile with GSLB

```
gslb.example.com {
    file /etc/coredns/db.gslb.example.com gslb.example.com
    gslb {
        zone gslb.example.com. /etc/coredns/db.gslb.example.com.yml
    }
    log
    errors
    reload 10s
}
```

### Example GSLB YAML Config

```yaml
healthcheck_profiles:
  http_default:
    type: http
    params:
      port: 80
      uri: "/"
      expected_code: 200
      timeout: 5s

records:
  webapp.gslb.example.com.:
    mode: failover
    record_ttl: 30
    scrape_interval: 10s
    backends:
      - address: "192.168.1.10"
        priority: 1
        healthchecks:
          - http_default
      - address: "192.168.1.11"
        priority: 2
        healthchecks:
          - http_default
```

### GSLB Load Balancing Modes

| Mode | Description |
|------|-------------|
| `failover` | Routes to highest-priority healthy backend |
| `roundrobin` | Cycles through healthy backends in sequence |
| `random` | Distributes randomly across healthy backends |
| `weighted` | Distributes based on backend weight values |
| `geoip` | Routes based on client geographic location |

## Docker Compose

The included `docker-compose.yml` runs CoreDNS-GSLB and the manager side by side:

```yaml
services:
  coredns:
    image: dmachard/coredns_gslb:latest
    container_name: coredns
    restart: unless-stopped
    ports:
      - "53:53/udp"
      - "53:53/tcp"
      - "9153:9153"
    volumes:
      - ./config/coredns:/etc/coredns
    command: ["-conf", "/etc/coredns/Corefile"]

  coredns-manager:
    build: .
    container_name: coredns-manager
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - COREFILE_PATH=/etc/coredns/Corefile
      - ZONE_DIR=/etc/coredns
      - GSLB_DIR=/etc/coredns
      - MASTER_PASSWORD=changeme
      - JWT_SECRET=change-this-secret
      - COREDNS_CONTAINER_NAME=coredns
    volumes:
      - ./config/coredns:/etc/coredns
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - coredns
```

## Architecture

```
simple-coredns-gslb-manager/
├── main.go                          # Entry point, route registration
├── internal/
│   ├── config/config.go             # Environment variable loading
│   ├── auth/
│   │   ├── auth.go                  # bcrypt verify, JWT generation, cookies
│   │   └── middleware.go            # JWT auth middleware (redirect on fail)
│   ├── docker/docker.go             # Container discovery + SIGUSR1 reload
│   ├── coredns/
│   │   ├── corefile.go              # Read/write/validate Corefile (atomic writes)
│   │   ├── zone.go                  # Zone file CRUD with SOA serial management
│   │   ├── gslb.go                  # GSLB YAML config management
│   │   └── diff.go                  # Unified diff generation
│   ├── handlers/                    # HTTP handlers (dashboard, corefile, zones, gslb, etc.)
│   └── templates/renderer.go        # Go html/template renderer for Echo
├── templates/                       # HTML templates (Bootstrap 5 + HTMX)
├── config/coredns/                  # Example CoreDNS + GSLB configuration
├── Dockerfile                       # Multi-stage build (~15-20MB image)
└── docker-compose.yml
```

## Tech Stack

| Component | Choice |
|-----------|--------|
| Backend | Go + [Echo v4](https://echo.labstack.com/) |
| Frontend | Bootstrap 5 + [HTMX](https://htmx.org/) (both via CDN) |
| Auth | bcrypt + JWT (httpOnly cookie) |
| DNS parsing | [miekg/dns](https://github.com/miekg/dns) |
| GSLB config | [gopkg.in/yaml.v3](https://pkg.go.dev/gopkg.in/yaml.v3) |
| Docker | [Docker Engine SDK](https://pkg.go.dev/github.com/docker/docker) |
| Diff | [gotextdiff](https://github.com/hexops/gotextdiff) |
| GSLB plugin | [CoreDNS-GSLB](https://github.com/dmachard/coredns-gslb) |

## Security

- **Atomic file writes** — Write to temp file, then `os.Rename` to prevent corrupt configs
- **Path traversal protection** — Domain names validated against `[a-zA-Z0-9.-]` regex
- **Zone file validation** — Zone files parsed with `miekg/dns` before saving (SOA required)
- **GSLB config validation** — YAML configs validated for required fields, valid modes, and backend structure
- **CSRF protection** — Echo CSRF middleware with token in form fields and HTMX header
- **Rate limiting** — Login endpoint limited to 5 burst / 1 req/sec per IP
- **httpOnly cookies** — JWT stored in httpOnly, SameSite=Strict cookies
- **Concurrent write safety** — `sync.RWMutex` protects file operations

## Development

```bash
# Run locally (requires Go 1.24+)
export COREFILE_PATH=./config/coredns/Corefile
export ZONE_DIR=./config/coredns
export GSLB_DIR=./config/coredns
export MASTER_PASSWORD=dev
export JWT_SECRET=dev-secret
go run .
```

## License

[MIT](LICENSE)
