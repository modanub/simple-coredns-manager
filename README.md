# simple-coredns-manager

A lightweight web UI for managing [CoreDNS](https://coredns.io/) configuration files. Edit your Corefile and host files with diff preview, then reload CoreDNS with one click.

> **Note:** This project was fully generated by [Claude Opus 4.6](https://www.anthropic.com/claude) (Anthropic's AI model) via [Claude Code](https://claude.com/claude-code) as an experiment in AI-driven software development. No human-written code.
>
> Originally built for the infrastructure part of [MWIT-LINK](https://mwit.link/) (Mahidol Wittayanusorn School) to manage internal DNS records.

## Features

- **Corefile editor** — Edit your CoreDNS Corefile in a web-based editor with syntax-aware textarea
- **Host file management** — Create, edit, and delete host files (`hosts.example.com` format)
- **Diff preview** — See unified diffs of your changes before saving (powered by HTMX)
- **One-click reload** — Send SIGUSR1 to CoreDNS container to pick up config changes
- **Master password auth** — Simple single-password login with bcrypt + JWT cookie sessions
- **Docker-native** — Runs alongside CoreDNS sharing config volumes, communicates via Docker socket
- **Graceful degradation** — Works without Docker socket (reload features disabled)

## Screenshots

The UI uses Bootstrap 5 with dark theme. Pages include a dashboard with CoreDNS status, a Corefile editor with diff preview, and a host file manager with CRUD operations.

## Quick Start

```bash
git clone https://github.com/modanub/simple-coredns-manager.git
cd simple-coredns-manager
docker compose up --build
```

Open [http://localhost:8080](http://localhost:8080) and log in with password `changeme`.

## Configuration

All configuration is via environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `COREFILE_PATH` | *(required)* | Path to the CoreDNS Corefile |
| `HOSTS_DIR` | *(required)* | Directory containing host files |
| `MASTER_PASSWORD` | *(required)* | Plaintext or bcrypt hash (auto-detected by `$2a$`/`$2b$` prefix) |
| `JWT_SECRET` | *(required)* | Secret key for signing JWT session tokens |
| `COREDNS_CONTAINER_NAME` | `coredns` | Docker container name for CoreDNS |
| `PORT` | `8080` | HTTP listen port |

### Using a pre-hashed password

```bash
# Generate a bcrypt hash
htpasswd -nbBC 12 "" 'your-password' | cut -d: -f2

# Use it directly
MASTER_PASSWORD='$2b$12$...'
```

## Docker Compose

The included `docker-compose.yml` runs CoreDNS and the manager side by side:

```yaml
services:
  coredns:
    image: coredns/coredns:latest
    container_name: coredns
    restart: unless-stopped
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    volumes:
      - ./config/coredns:/etc/coredns
    command: -conf /etc/coredns/Corefile

  coredns-manager:
    build: .
    container_name: coredns-manager
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - COREFILE_PATH=/etc/coredns/Corefile
      - HOSTS_DIR=/etc/coredns/hosts/
      - MASTER_PASSWORD=changeme
      - JWT_SECRET=change-this-secret
      - COREDNS_CONTAINER_NAME=coredns
    volumes:
      - ./config/coredns:/etc/coredns
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - coredns
```

## Architecture

```
simple-coredns-manager/
├── main.go                          # Entry point, route registration
├── internal/
│   ├── config/config.go             # Environment variable loading
│   ├── auth/
│   │   ├── auth.go                  # bcrypt verify, JWT generation, cookies
│   │   └── middleware.go            # JWT auth middleware (redirect on fail)
│   ├── docker/docker.go             # Container discovery + SIGUSR1 reload
│   ├── coredns/
│   │   ├── corefile.go              # Read/write/validate Corefile (atomic writes)
│   │   ├── hosts.go                 # Host file CRUD with path traversal protection
│   │   └── diff.go                  # Unified diff generation
│   ├── handlers/                    # HTTP handlers (dashboard, corefile, hosts, etc.)
│   └── templates/renderer.go        # Go html/template renderer for Echo
├── templates/                       # HTML templates (Bootstrap 5 + HTMX)
├── config/coredns/                  # Example CoreDNS configuration
├── Dockerfile                       # Multi-stage build (~15-20MB image)
└── docker-compose.yml
```

## Tech Stack

| Component | Choice |
|-----------|--------|
| Backend | Go + [Echo v4](https://echo.labstack.com/) |
| Frontend | Bootstrap 5 + [HTMX](https://htmx.org/) (both via CDN) |
| Auth | bcrypt + JWT (httpOnly cookie) |
| Docker | [Docker Engine SDK](https://pkg.go.dev/github.com/docker/docker) |
| Diff | [gotextdiff](https://github.com/hexops/gotextdiff) |

## Security

- **Atomic file writes** — Write to temp file, then `os.Rename` to prevent corrupt configs
- **Path traversal protection** — Domain names validated against `[a-zA-Z0-9.-]` regex
- **CSRF protection** — Echo CSRF middleware with token in form fields and HTMX header
- **Rate limiting** — Login endpoint limited to 5 burst / 1 req/sec per IP
- **httpOnly cookies** — JWT stored in httpOnly, SameSite=Strict cookies
- **Concurrent write safety** — `sync.RWMutex` protects file operations

## Development

```bash
# Run locally (requires Go 1.23+)
export COREFILE_PATH=./config/coredns/Corefile
export HOSTS_DIR=./config/coredns/hosts/
export MASTER_PASSWORD=dev
export JWT_SECRET=dev-secret
go run .
```

## License

[MIT](LICENSE)
